<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Apex CIP Map</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://terrymah.github.io/cipmap/">
    <meta property="og:title" content="Apex CIP Map">
    <meta property="og:description" content="Explore Town of Apex Capital Improvement Projects - view locations, funding, and timelines on an interactive map.">
    <meta property="og:image" content="https://terrymah.github.io/cipmap/preview.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="530">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Apex CIP Map">
    <meta name="twitter:description" content="Explore Town of Apex Capital Improvement Projects - view locations, funding, and timelines on an interactive map.">
    <meta name="twitter:image" content="https://terrymah.github.io/cipmap/preview.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icons/hat.png">
    <link rel="apple-touch-icon" href="icons/hat.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- App CSS -->
    <link rel="stylesheet" href="styles.css?v=20260101z">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle project list">
                    <i class="fas fa-list"></i>
                </button>
                <div class="header-content">
                    <h1 id="app-title" class="title-loading">Capital Improvement Projects</h1>
                    <p id="app-subtitle" class="subtitle"></p>
                </div>
            </div>
            <div class="header-stats">
                <span id="projectCount">0 Projects</span>
                <span class="stats-separator">â€¢</span>
                <span id="totalFunding">$0 Total</span>
            </div>
            <div class="header-search">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search projects...">
                    <button class="clear-search" id="clearSearch" aria-label="Clear search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-download" id="downloadCsvBtn" hidden>
                    <i class="fas fa-download"></i>
                    <span>Download CSV</span>
                </button>
                <button class="user-btn" id="userBtn" title="Set your identity">
                    <i class="fas fa-question"></i>
                </button>
            </div>
            <button class="mobile-menu-toggle" id="menuToggle" aria-label="Toggle menu">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar / Project List -->
            <aside class="sidebar collapsed" id="sidebar">
                <!-- Filters -->
                <div class="filters-section">
                    <div class="filter-toggles">
                        <button class="filter-toggle-btn active" id="filterToggle">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                    </div>
                    
                    <div class="filters-panel" id="filtersPanel">
                        <div class="filter-group">
                            <label>Project Type</label>
                            <div class="filter-options" id="typeFilters"></div>
                        </div>
                        
                        <div class="filter-group">
                            <label>Status</label>
                            <div class="filter-options" id="statusFilters"></div>
                        </div>
                        
                        <div class="filter-group">
                            <label>Priority</label>
                            <div class="filter-options" id="priorityFilters"></div>
                        </div>

                        <div class="filter-group">
                            <label>Funding Years</label>
                            <div class="range-slider-container">
                                <div class="range-slider" id="fundingYearSlider">
                                    <div class="range-track">
                                        <div class="range-fill"></div>
                                    </div>
                                    <input type="range" class="range-input range-min" id="fundingYearMin">
                                    <input type="range" class="range-input range-max" id="fundingYearMax">
                                </div>
                                <div class="range-labels">
                                    <span class="range-label-min" id="fundingYearMinLabel"></span>
                                    <span class="range-label-max" id="fundingYearMaxLabel"></span>
                                </div>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>Project Timeline</label>
                            <div class="range-slider-container">
                                <div class="range-slider" id="timelineSlider">
                                    <div class="range-track">
                                        <div class="range-fill"></div>
                                    </div>
                                    <input type="range" class="range-input range-min" id="timelineMin">
                                    <input type="range" class="range-input range-max" id="timelineMax">
                                </div>
                                <div class="range-labels">
                                    <span class="range-label-min" id="timelineMinLabel"></span>
                                    <span class="range-label-max" id="timelineMaxLabel"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-actions">
                            <label class="checkbox-filter" id="noLocationFilter">
                                <input type="checkbox" id="noLocationCheckbox">
                                <span><i class="fas fa-map-marker-alt"></i> Show only projects without location</span>
                            </label>
                            <button class="btn btn-secondary" id="clearFilters">Clear All</button>
                        </div>
                    </div>
                </div>

                <!-- Project List -->
                <div class="project-list-section">
                    <div class="project-list" id="projectList">
                        <!-- Projects will be inserted here -->
                    </div>
                </div>
            </aside>
            
            <!-- Sidebar close button (after sidebar for CSS sibling selector) -->
            <button class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
                <i class="fas fa-times"></i>
            </button>

            <!-- Location Assignment Banner (hidden by default) -->
            <div class="location-assign-banner" id="locationAssignBanner" hidden>
                <span class="banner-text">Click on the map to assign location for:</span>
                <span class="banner-project" id="bannerProjectName"></span>
                <button class="btn-cancel" id="cancelLocationAssign">Cancel</button>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div id="map"></div>
                
                <!-- Floating Logo -->
                <a class="floating-logo" id="floatingLogo" href="#" target="_blank" rel="noopener" hidden>
                    <img id="logoImage" src="" alt="">
                </a>
                
                <!-- Map Legend -->
                <div class="map-legend" id="mapLegend">
                    <div class="legend-header">
                        <span>Legend</span>
                        <button class="legend-toggle" id="legendToggle">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="legend-content" id="legendContent">
                        <!-- Legend items will be inserted here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Project Detail Modal/Panel -->
        <div class="project-detail-overlay" id="detailOverlay">
            <div class="project-detail-panel" id="detailPanel">
                <button class="close-detail" id="closeDetail" aria-label="Close details">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="detail-content" id="detailContent">
                    <!-- Project details will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- ==========================================
         HTML Templates
         ========================================== -->
    
    <!-- Project Card Template -->
    <template id="template-project-card">
        <div class="project-card" data-project-id="">
            <div class="project-card-header">
                <div class="project-type-column">
                    <div class="project-type-icon">
                        <i class="fas"></i>
                    </div>
                    <span class="funding-amount"></span>
                </div>
                <div class="project-card-title">
                    <h3 class="project-name"></h3>
                    <div class="project-card-meta">
                        <span class="meta-badge status-badge"></span>
                        <span class="meta-badge priority-badge"></span>
                        <span class="no-location-badge" hidden>
                            <i class="fas fa-map-marker-alt"></i> No location
                        </span>
                    </div>
                </div>
                <div class="project-card-actions">
                    <button class="vote-btn upvote-btn" title="Upvote this project">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="vote-btn downvote-btn" title="Downvote this project">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button class="vote-btn comment-btn" title="Comment on this project">
                        <i class="fas fa-comment"></i>
                        <span class="comment-count" hidden></span>
                    </button>
                </div>
                <div class="project-card-results" hidden>
                    <span class="results-vote-score" title="Vote score">0</span>
                    <button class="vote-btn comment-btn results-comment-btn" title="View comments">
                        <i class="fas fa-comment"></i>
                        <span class="comment-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- Empty State Template -->
    <template id="template-empty-state">
        <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>No projects found</h3>
            <p>Try adjusting your filters or search terms.</p>
        </div>
    </template>

    <!-- Error State Template -->
    <template id="template-error-state">
        <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error</h3>
            <p class="error-message"></p>
        </div>
    </template>

    <!-- Map Marker Template -->
    <template id="template-map-marker">
        <div class="custom-marker">
            <i class="fas"></i>
        </div>
    </template>

    <!-- Legend Item Template -->
    <template id="template-legend-item">
        <div class="legend-item">
            <div class="legend-color"></div>
            <span class="legend-label"></span>
        </div>
    </template>

    <!-- Filter Chip Template -->
    <template id="template-filter-chip">
        <button class="filter-chip">
            <span class="color-dot" hidden></span>
            <span class="chip-label"></span>
        </button>
    </template>

    <!-- Project Detail Template -->
    <template id="template-project-detail">
        <div class="detail-header">
            <span class="detail-type-badge">
                <i class="fas"></i>
                <span class="type-label"></span>
            </span>
            <div class="detail-title-row">
                <h2 class="project-name"></h2>
                <div class="detail-vote-buttons">
                    <div class="vote-row">
                        <button class="vote-btn upvote-btn" title="Upvote this project">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <span class="vote-score" title="Score">--</span>
                        <button class="vote-btn downvote-btn" title="Downvote this project">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                    <div class="comment-row">
                        <button class="vote-btn comment-btn" title="Comment on this project">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="detail-meta">
                <span class="meta-badge status-badge"></span>
                <span class="meta-badge priority-badge"></span>
            </div>
        </div>

        <div class="detail-section">
            <h3>Description</h3>
            <p class="detail-description"></p>
        </div>

        <div class="detail-section location-section" hidden>
            <h3>Location</h3>
            <p class="detail-location">
                <i class="fas fa-map-marker-alt"></i>
                <span class="location-name"></span>
            </p>
        </div>

        <div class="detail-section">
            <h3>Funding Plan</h3>
            <table class="funding-table">
                <thead>
                    <tr>
                        <th>Fiscal Year</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody class="funding-body">
                    <!-- Funding rows inserted here -->
                </tbody>
            </table>
            <p class="funding-source-text" style="margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary);" hidden>
                <strong>Funding Source:</strong> <span class="funding-source"></span>
            </p>
            <p class="funding-note" style="margin-top: 8px; font-size: 0.8rem; font-style: italic; color: var(--text-secondary);" hidden>
                * Total includes funding from years or sources not listed here
            </p>
        </div>

        <div class="detail-section timeline-section" hidden>
            <h3>Timeline</h3>
            <div class="timeline">
                <!-- Timeline items inserted here -->
            </div>
        </div>

        <div class="detail-section department-section" hidden>
            <h3>Responsible Department</h3>
            <p class="department-name"></p>
        </div>

        <div class="detail-actions">
            <a href="" target="_blank" rel="noopener noreferrer" class="btn btn-primary learn-more-btn" hidden>
                <i class="fas fa-external-link-alt"></i> Learn More
            </a>
            <button class="btn btn-outline add-link-btn" hidden>
                <i class="fas fa-link"></i> Add Link
            </button>
            <button class="btn btn-secondary view-map-btn" hidden>
                <i class="fas fa-map-marker-alt"></i> View on Map
            </button>
        </div>
    </template>

    <!-- Funding Row Template -->
    <template id="template-funding-row">
        <tr>
            <td class="fiscal-year"></td>
            <td class="fiscal-amount"></td>
        </tr>
    </template>

    <!-- Funding Total Row Template -->
    <template id="template-funding-total">
        <tr class="total-row">
            <td><strong><span class="total-label">Total</span></strong></td>
            <td><strong class="total-amount"></strong></td>
        </tr>
    </template>

    <!-- Timeline Item Template -->
    <template id="template-timeline-item">
        <div class="timeline-item">
            <div class="timeline-dot"></div>
            <span class="timeline-label"></span>
            <span class="timeline-date"></span>
        </div>
    </template>

    <!-- User Dialog Overlay -->
    <div class="dialog-overlay" id="userDialogOverlay" hidden></div>
    
    <!-- User Dialog -->
    <div class="user-dialog" id="userDialog" hidden>
        <button class="dialog-close-btn" id="userDialogClose" aria-label="Close dialog">
            <i class="fas fa-times"></i>
        </button>
        <div class="dialog-header">
            <h2>Profile</h2>
            <p class="dialog-banner" id="userDialogBanner" hidden></p>
            <div class="wizard-progress" id="wizardProgress">
                <span class="wizard-step active" data-step="1">1. Info</span>
                <span class="wizard-step" data-step="2">2. Location</span>
            </div>
        </div>
        <div class="dialog-body">
            <!-- Step 1: Name and Email -->
            <div class="wizard-panel" id="wizardStep1">
                <div class="form-group">
                    <label for="userFirstName">First Name</label>
                    <input type="text" id="userFirstName" placeholder="Enter your first name">
                </div>
                <div class="form-group">
                    <label for="userLastName">Last Name</label>
                    <input type="text" id="userLastName" placeholder="Enter your last name">
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" placeholder="Enter your email address">
                </div>
            </div>
            <!-- Step 2: Location -->
            <div class="wizard-panel" id="wizardStep2">
                <div class="form-group">
                    <label>Approximate Location</label>
                    <div class="user-location-map" id="userLocationMap"></div>
                    <p class="location-hint" id="userLocationHint">Click on a hexagon to select your area</p>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" id="userDialogBack" hidden>Back</button>
            <button class="btn btn-secondary" id="userDialogCancel">Cancel</button>
            <button class="btn btn-primary" id="userDialogNext">Next</button>
            <button class="btn btn-primary" id="userDialogOk" hidden disabled>OK</button>
        </div>
    </div>

    <!-- Comment Dialog Overlay -->
    <div class="dialog-overlay" id="commentDialogOverlay" hidden></div>
    
    <!-- Comment Dialog -->
    <div class="comment-dialog" id="commentDialog" hidden>
        <button class="dialog-close-btn" id="commentDialogClose" aria-label="Close dialog">
            <i class="fas fa-times"></i>
        </button>
        <div class="dialog-header">
            <h2>Comments</h2>
            <p class="comment-project-name" id="commentProjectName"></p>
        </div>
        <div class="dialog-body">
            <div class="previous-comments" id="previousComments">
                <!-- Previous comments will be inserted here -->
            </div>
            <div class="form-group">
                <label for="commentInput">Add a comment</label>
                <textarea id="commentInput" rows="3" placeholder="Share your thoughts on this project..."></textarea>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" id="commentDialogCancel">Cancel</button>
            <button class="btn btn-primary" id="commentDialogOk">OK</button>
        </div>
    </div>

    <!-- Help Dialog Overlay -->
    <div class="dialog-overlay" id="helpDialogOverlay" hidden></div>
    
    <!-- Help Dialog -->
    <div class="help-dialog" id="helpDialog" hidden>
        <button class="dialog-close-btn" id="helpDialogClose" aria-label="Close dialog">
            <i class="fas fa-times"></i>
        </button>
        <div class="dialog-header">
            <h2>Welcome</h2>
        </div>
        <div class="dialog-body">
            <div class="help-content" id="helpContent">
                <!-- Help text will be inserted here -->
            </div>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-primary" id="helpDialogOk">Got it!</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- App JS (ES6 Modules) -->
    <script type="module" src="js/main.js?v=20260109c"></script>
</body>
</html>
